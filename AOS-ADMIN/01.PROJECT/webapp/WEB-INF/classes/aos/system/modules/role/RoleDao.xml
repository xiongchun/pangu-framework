<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 角色管理模块使用的SQL语句 -->
<mapper namespace="Role">

	<!-- 查询角色列表 -->
	<select id="listRolesPage" resultType="Dto" parameterType="Dto">
	       SELECT * FROM (
			SELECT
			(SELECT cascade_id_ FROM aos_org WHERE id_ = (SELECT org_id_ FROM aos_user WHERE id_ = aos_role.create_by_)) AS org_cascade_id_,
            <include refid="aos.system.dao.Aos_roleDao.column" />
            FROM aos_role
			<where>
			    <if test="name_ != null and name_ != ''">
				    AND name_ LIKE '%${name_}%' 
				</if>
				<if test="type_ != null and type_ != ''">
				    AND type_ = #{type_}
				</if>
			</where>	
			) t WHERE t.org_cascade_id_ LIKE '${org_cascade_id_}%' 
			ORDER BY id_ DESC
	</select>
	
	<!-- 删除人员角色关联表 -->
	<delete id="deleteUserRoleByRoleID" parameterType="String">
	   DELETE FROM aos_user_role WHERE role_id_ = #{role_id_}
	</delete>
	
	<!-- 查询授权树 -->
	<select id="listTreeData4Grant" resultType="Aos_modulePO" parameterType="Dto">
			SELECT
            <include refid="aos.system.dao.Aos_moduleDao.column" />
            FROM aos_module WHERE
				id_ IN (
					SELECT
						module_id_
					FROM
						aos_role_module
					WHERE
						grant_type_ = '2'
					AND role_id_ IN (
						SELECT
							role_id_
						FROM
							aos_user_role
						WHERE
							user_id_ = #{user_id_}
					))
			 ORDER BY sort_no_
	</select>
	
	<!-- 删除角色模块关联表 -->
	<delete id="deleteRoleModuleByRoleID" parameterType="Dto">
	   DELETE FROM aos_role_module WHERE role_id_ = #{role_id_} AND grant_type_ = #{grant_type_}
	</delete>
	
	<!-- 查询用户列表 -->
	<select id="listUsersPage" resultType="Dto" parameterType="Dto">
			SELECT
			     aos_org.name_ AS org_name_,
                <include refid="aos.framework.dao.Aos_userDao.column2" />
            FROM aos_user, aos_org WHERE aos_user.org_id_ = aos_org.id_
              AND aos_user.id_ NOT IN (SELECT user_id_ FROM aos_user_role WHERE role_id_ = #{role_id_})
		    <if test="na_ != null and na_ != ''">
			    AND (aos_user.name_ LIKE '%${na_}%' OR aos_user.account_ LIKE '%${na_}%')
			</if>
		    <if test="cascade_ == 0">
			    AND aos_user.org_id_ = #{org_id_, jdbcType=VARCHAR} 
			</if>
			<if test="cascade_ == 1">
			    AND aos_org.cascade_id_ like '${org_cascade_id_}%'
			</if>
			<if test="is_del_ != null and is_del_ != ''">
			    AND aos_user.is_del_ = #{is_del_} 
			</if>
			 ORDER BY aos_user.id_ DESC
	</select>
	
	<!-- 查询已选用户列表 -->
	<select id="listSelectedUsersPage" resultType="Dto" parameterType="Dto">
			SELECT
				aos_org.name_ as org_name_,
				aos_user_role.id_ as user_role_id_,
                <include refid="aos.framework.dao.Aos_userDao.column2" />
            FROM aos_user
			LEFT JOIN aos_user_role ON aos_user_role.user_id_ = aos_user.id_
			LEFT JOIN aos_org ON aos_org.id_ = aos_user.org_id_
            WHERE aos_user.id_ IN (SELECT user_id_ FROM aos_user_role WHERE role_id_ = #{role_id_})
                AND aos_user_role.role_id_ = #{role_id_}
		    <if test="na_ != null and na_ != ''">
			    AND (aos_user.name_ LIKE '%${na_}%' OR aos_user.account_ LIKE '%${na_}%')
			</if>
			<if test="is_del_ != null and is_del_ != ''">
			    AND aos_user.is_del_ = #{is_del_} 
			</if>
			 ORDER BY aos_user.id_ DESC
	</select>

</mapper>